
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç‹¸æ—¥èªãƒ»å­¸å“¡ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap');
        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: #FFFFFF; 
            font-weight: bold; 
            font-size: 18px; 
            -webkit-font-smoothing: antialiased;
        }
        .card-container { border: 2px solid #F3F4F6; padding: 2rem; border-radius: 36px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .btn-zoom { 
            background-color: #2D8CFF; color: white; padding: 1.25rem; border-radius: 1.25rem; width: 100%; 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            box-shadow: 0 10px 20px rgba(45, 140, 255, 0.2); 
        }
        .btn-blue { background-color: #60A5FA; color: white; padding: 1rem; border-radius: 1.25rem; width: 100%; }
        .teacher-box { background-color: #F3F4F6; border: 2px dashed #D1D5DB; padding: 1.5rem; border-radius: 24px; margin: 1.5rem 0; }
        .btn-teacher-deduct { background-color: #9CA3AF; color: white; padding: 0.6rem; border-radius: 0.75rem; width: 100%; margin-bottom: 8px; font-size: 14px; }
        .btn-teacher-add { background-color: #D1D5DB; color: #4B5563; padding: 0.6rem; border-radius: 0.75rem; width: 100%; font-size: 14px; }
        .input-field { width: 100%; padding: 1rem; margin-bottom: 1rem; border: 2px solid #F3F4F6; border-radius: 1.25rem; outline: none; text-align: center; font-weight: bold; }
        .history-item { color: #9CA3AF; font-size: 13px; font-weight: normal; padding: 4px 0; border-bottom: 1px solid #F9FAFB; }
        details summary { cursor: pointer; color: #9CA3AF; font-size: 14px; font-weight: normal; margin-top: 15px; outline: none; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-md mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 leading-tight">å°ç‹¸æ—¥èªå­¸å“¡ãƒ¼<br>èª²å‹™èˆ‡ç¹³è²»ç³»çµ±</h1>
        </header>

        <div id="login-box" class="card-container text-center">
            <h2 class="text-xl mb-6">å­¸å“¡ç™»å…¥</h2>
            <input type="email" id="login-email" placeholder="æ‚¨çš„ Email" class="input-field">
            <button onclick="checkStatus('login_record')" id="login-btn" class="btn-blue shadow-lg font-bold">é€²å…¥ç³»çµ±</button>
        </div>

        <div id="status-box" class="hidden">
            <div class="card-container border-blue-400 bg-blue-50/30 mb-6 text-center">
                <p class="text-blue-600 mb-4 text-sm font-bold">é€²å…¥æ•™å®¤è‡ªå‹•ç°½åˆ°</p>
                <button onclick="enterZoom()" class="btn-zoom text-xl font-bold">ğŸ“¹ é€²å…¥ Zoom æ•™å®¤</button>
            </div>

            <div class="card-container mb-6 text-center">
                <div class="text-xs text-blue-500 mb-2 text-left font-normal">å­¸å“¡ï¼š<span id="res-name">---</span></div>
                <p class="text-gray-500 mb-1 font-bold">èª²ç¨‹é€²åº¦ (å·²ä¸Š / ç¸½å…±)</p>
                <div class="text-6xl text-blue-600 mb-4 font-bold"><span id="res-used">0</span> / <span id="res-total">0</span></div>
                
                <div class="teacher-box text-center">
                    <p class="text-gray-500 text-xs mb-3 font-bold">â›” è€å¸«å°ˆç”¨å€ï¼Œå­¸å“¡å‹¿å‹•å–”ï¼</p>
                    <button onclick="teacherAction('manual_deduct')" class="btn-teacher-deduct font-bold">æ‰‹å‹•æ‰£èª² (æ› èª²/é²åˆ°)</button>
                    <button onclick="teacherAction('add_lesson')" class="btn-teacher-add font-bold">ğŸ çå‹µåŠ èª²</button>
                </div>

                <div class="text-left mt-4">
                    <p class="text-gray-400 text-xs mb-2 font-normal">ğŸ•’ æœ¬æœŸç´€éŒ„ï¼š</p>
                    <div id="res-history" class="flex flex-col"></div>
                    
                    <details class="mt-4">
                        <summary>ğŸ“ æŸ¥è©¢èˆŠæœŸæ•¸ç´€éŒ„</summary>
                        <div id="res-old-history" class="text-xs font-normal text-gray-400 mt-2 bg-gray-50 p-3 rounded-xl leading-relaxed"></div>
                    </details>
                </div>
            </div>

            <div class="card-container mb-6">
                <h3 class="mb-4 text-blue-500 text-sm text-left font-bold">ğŸ’° çºŒè²»/ç¹³è²»å›å ±</h3>
                <input type="number" id="report-amount" class="input-field" placeholder="é‡‘é¡">
                <input type="text" id="report-five" class="input-field" placeholder="æœ«äº”ç¢¼">
                <button onclick="submitPayment()" class="w-full bg-green-400 text-white py-3 rounded-2xl font-bold">æäº¤å›å ±</button>
            </div>
            
            <button onclick="logout()" class="w-full text-gray-400 text-sm underline text-center font-normal">ç™»å‡ºç³»çµ±</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbssQPhEYFNz1Y6vBeEEpd4zSPpmuvCmZsVm7x3ifX0p0k6fayO3TkC2Sh5OGGDprl-/exec";
        const ZOOM_LINK = "https://zoom.us/j/93019761780";

        async function checkStatus(action) {
            const email = document.getElementById('login-email').value.trim();
            if(!email) return;
            try {
                const res = await fetch(`${GAS_URL}?email=${encodeURIComponent(email)}&action=${action || ''}`);
                const data = await res.json();
                if(data.status === "success") {
                    localStorage.setItem('korri_student_email', email);
                    document.getElementById('res-used').innerText = data.used;
                    document.getElementById('res-total').innerText = data.total;
                    document.getElementById('res-name').innerText = data.name;
                    document.getElementById('res-history').innerHTML = data.history
                        .filter(h => h.trim() !== "").map(h => `<div class="history-item">${h}</div>`).join('');
                    
                    const oldHtml = data.oldHistory && data.oldHistory.length > 0 
                        ? data.oldHistory.map(h => `<div class="mb-4 border-b border-gray-100 pb-2 text-gray-400">${h.replace(/\\n/g, '<br>')}</div>`).join('')
                        : "å°šç„¡èˆŠç´€éŒ„";
                    document.getElementById('res-old-history').innerHTML = oldHtml;

                    document.getElementById('login-box').classList.add('hidden');
                    document.getElementById('status-box').classList.remove('hidden');
                } else { alert("æŸ¥ç„¡è³‡æ–™"); }
            } catch (e) { alert("é€£ç·šå¤±æ•—"); }
        }

        async function enterZoom() {
            const email = localStorage.getItem('korri_student_email');
            await fetch(`${GAS_URL}?email=${encodeURIComponent(email)}&action=zoom_checkin`);
            window.open(ZOOM_LINK, '_blank');
            setTimeout(() => checkStatus(), 2000);
        }

        async function teacherAction(action) {
            const msg = action === 'manual_deduct' ? "ã€è€å¸«ç¢ºèªã€‘è¦æ‰‹å‹•æ‰£é™¤ä¸€å ‚èª²å—ï¼Ÿ" : "ã€è€å¸«ç¢ºèªã€‘è¦çå‹µä¸€å ‚èª²å—ï¼Ÿ";
            if(!confirm(msg)) return;
            const email = localStorage.getItem('korri_student_email');
            await fetch(`${GAS_URL}?email=${encodeURIComponent(email)}&action=${action}`);
            checkStatus();
        }

        async function submitPayment() {
            const email = localStorage.getItem('korri_student_email');
            const amount = document.getElementById('report-amount').value;
            const five = document.getElementById('report-five').value;
            await fetch(GAS_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ email, amount, lastFive: five, name: document.getElementById('res-name').innerText }) 
            });
            alert("å·²æ”¶åˆ°å›å ±");
        }

        function logout() { 
            localStorage.removeItem('korri_student_email'); 
            location.reload(); 
        }

        window.onload = () => {
            const saved = localStorage.getItem('korri_student_email');
            if(saved) { 
                document.getElementById('login-email').value = saved; 
                checkStatus();
            }
        };
    </script>
</body>
</html>
